## 09 | 块级作用域：var 缺陷以及为什么要引入 let 和 const？

1. 作用域

   **作用域是指在程序中定义变量的区域，该位置决定了变量的生命周期**。通俗地理解，作用域就是变量与函数的可访问范围，即作用域控制着变量和函数的`可见性和生命周期`。

   js作用域

   - 全局作用域

     该作用域中对象在代码中的任何地方都能访问，生命周期伴随着页面的生命周期

   - 函数作用域

     定义的变量或函数，只能在函数内部被访问。**函数执行之后，函数内部定义的变量会被销毁**

   - 块级作用域

     使用一对大括号包裹的一段代码

2. 变量提升所带来的问题

   - 变量容易在不被察觉的情况下被覆盖掉

     ```javascript
     
     var myname = "极客时间"
     function showName(){
       console.log(myname);
       if(0){
        var myname = "极客邦"
       }
       console.log(myname);
     }
     showName()
     // undefined undefined
     ```

   - 本该销毁的变量没有被销毁(变成了全局变量)

     ```javascript
     
     function foo(){
       for (var i = 0; i < 7; i++) {
       }
       console.log(i); //7
     }
     foo()
     // 一般来说，for循环结束，i已经被销毁，在这里，i变成了全局变量，随全局变量一起销毁
     ```

3. es6怎么解决变量提升带来的缺陷

   引入了`let`和`const`

   ```javascript
   function varTest() {
     var x = 1;
     if (true) {
       var x = 2;  // 同样的变量!
       console.log(x);  // 2
     }
     console.log(x);  // 2
   } 
   varTest()
   
   //使用let定义，作用域块内声明的变量不影响块外面的变量。
   function varTest() {
     var x = 1;
     if (true) {
       let x = 2;  // 同样的变量!
       console.log(x);  // 2
     }
     console.log(x);  // 1
   } 
   varTest()
   ```

4. JavaScript是如何支持块级作用域的

   > 块级作用域就是通过词法环境的栈结构来实现的，而变量提升是通过变量环境来实现，通过这两者的结合

   ```javascript
   function foo(){
       var a = 1
       let b = 2
       {
         let b = 3
         var c = 4  //作用域为整个函数
         let d = 5
         console.log(a) //1
         console.log(b)  //3
       }
       console.log(b) //2
       console.log(c) //4
       console.log(d)  //d is not defined
   }   
   foo()
   ```

   - 编译并创建执行上下文

     1、函数内部var 声明的变量都在变量环境中，let声明的变量在词法环境

     2、在函数的作用域块内部，let声明的变量没有放在词法环境，而是存放在词法环境的一个单独的区域中，这个区域中的变量并不影响作用域块外面的变量

     3、 在词法环境内部，维护了一个小型栈结构，栈底是函数最外层的变量，进入一个作用域块后，就会把该作用域块内部的变量压到栈顶；当作用域执行完成之后，该作用域的信息就会从栈顶弹出

     **具体查找方式是：**沿着词法环境的栈顶向下查询，如果在词法环境中的某个块中查找到了，就直接返回给 JavaScript 引擎，如果没有查找到，那么继续在变量环境中查找<font color="red">块级作用域能访问到函数作用域中的变量</font>

**思考题：通过分析词法环境，得出来最终的打印结果吗？**

```javascript
let myname= '极客时间'
{
  console.log(myname) // 抛出异常  暂时性死区
  let myname= '极客邦'
}
```

