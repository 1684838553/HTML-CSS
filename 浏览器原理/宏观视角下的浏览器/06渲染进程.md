## 06 | 渲染流程（下）：HTML、CSS 和 JavaScript，是如何变成页面的？

1. 分层

   > 1. 特定节点生成专用图层，生成一棵图层树（层叠上下文、Clip，类似 PhotoShop 里的图层）；
   > 2. 拥有层叠上下文属性（明确定位属性、透明属性、CSS 滤镜、z-index 等）的元素会创建单独图层
   > 3. 没有图层的 DOM 节点属于父节点图层；
   > 4. 需要剪裁的地方也会创建图层。

2. 绘制指令

   > 1. 输入：图层树；
   > 2. 渲染引擎对图层树中每个图层进行绘制；
   > 3. 拆分成绘制指令，生成绘制列表，提交到合成线程；
   > 4. 输出：绘制列表。

3. 分块

   > 1. 合成线程会将较大、较长的图层（一屏显示不完，大部分不在视口内）划分为图块（tile, 256*256, 512*512）。

4. 光栅化（栅格化）

   > 1. 在光栅化线程池中，将视口附近的图块优先生成位图（栅格化执行该操作）；
   > 2. 快速栅格化：GPU 加速，生成位图（GPU 进程）。

5. 合成绘制

   > 1. 绘制图块命令——DrawQuad，提交给浏览器进程；
   > 2. 浏览器进程的 viz 组件，根据 DrawQuad 命令，绘制在屏幕上。

**相关概念**

6. 重排

   > 1. 更新了元素的几何属性（如宽、高、边距）；
   > 2. 触发重新布局，解析之后的一系列子阶段；
   > 3. 更新完成的渲染流水线，开销最大。

7. 重绘

   > 1. 更新元素的绘制属性（元素的颜色、背景色、边框等）；
   > 2. 布局阶段不会执行（无几何位置变换），直接进入绘制阶段。

8. 合成

   > 1. 直接进入合成阶段（例如 CSS 的 transform 动画）；
   > 2. 直接执行合成阶段，开销最小。

**思考题：你能总结出来为什么减少重绘、重排能优化 Web 性能吗？那又有那些具体的实践方法能减少重绘、重排呢？**

减少重排重绘, 方法很多：

1. 使用 class 操作样式，而不是频繁操作 style
2. 避免使用 table 布局
3. 批量 dom 操作，例如 createDocumentFragment，或者使用框架，例如 React
4. Debounce window resize 事件
5. 对 dom 属性的读写要分离
6. will-change: transform 做优化
