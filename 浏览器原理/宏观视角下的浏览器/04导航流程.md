## 04 | 导航流程：从输入 URL 到页面展示，这中间发生了什么？

用户发出 URL 请求到页面开始解析的这个过程，就叫做`导航`

### 从输入URL到页面展示

1. 用户输入

   > 地址栏会判断输入的关键字是搜索内容，还是请求的URL。为搜索内容时，地址栏会使用浏览器默认的搜索引擎，合成新的带搜索关键子的URL；为URL时，会根据协议，将URL合成完整。

2. url请求过程

   > 构建get请求 -》查找本地缓存-》域名解析（获取ip和端口）-》等待tcp队列-》建立TCP连接-》发送http请求 -》浏览器处理请求 -》服务器响应（返回请求数据和断开连接）

   - 重定向

     状态码 301 暂时重定向  302 永久重定向

     收到服务器响应后，状态码为301或302，说明服务器需要浏览器重定向到其他URL，这时网络进程从响应头中的Location字段读取重定向地址，发起新的请求

     如果服务器响应状态码为200，表示浏览器可以继续处理请求

   - 响应数据类型处理

     **URL 请求的数据类型，有时候是一个下载类型，有时候是正常的 HTML 页面，那么浏览器是如何区分它们呢？**

     `Content-Type 是 HTTP 头中一个非常重要的字段， 它告诉浏览器服务器返回的响应体数据是什么类型`，然后浏览器会根据 Content-Type 的值来决定如何显示响应体的内容。

     不同 Content-Type 的后续处理流程也截然不同。如果 Content-Type 字段的值被浏览器判断为下载类型，那么该请求会被提交给浏览器的下载管理器，同时该 URL 请求的导航流程就此结束。但如果是 HTML，那么浏览器则会继续进行导航流程

     常见的媒体格式类型

     > - `text/html ： HTML格式`
     > - text/plain ：纯文本格式
     > - text/xml ： XML格式
     > - image/gif ：gif图片格式
     > - image/jpeg ：jpg图片格式
     > - image/png：png图片格式

     以application开头的媒体格式类型：

     > - application/xhtml+xml ：XHTML格式
     > - application/xml： XML数据格式
     > - application/atom+xml ：Atom XML聚合格式
     > - application/json： JSON数据格式
     > - application/pdf：pdf格式
     > - application/msword ： Word文档格式
     > - `application/octet-stream ： 二进制流数据（如常见的文件下载）`
     > - application/x-www-form-urlencoded ： <form encType="">中默认的encType，form表单数据被编码为key/value格式发送到服务器（表单默认的提交数据的格式）
     > - multipart/form-data ： 需要在表单中进行文件上传时，就需要使用该格式

3. 准备渲染过程

   > Chrome 的默认策略是，每个标签对应一个渲染进程。但如果从一个页面打开了另一个新页面，而新页面和当前页面属于同一站点的话，那么新页面会复用父页面的渲染进程

4. 提交文档

   > 提交文档，就是指浏览器进程将网络进程接收到的 HTML 数据提交给渲染进程
   >
   > - 当浏览器进程接收到网络进程的响应头数据之后，便向渲染进程发起“提交文档”的消息；
   > - 渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”；
   > - 等文档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程；
   > - 浏览器进程在收到“确认提交”的消息后，会更新浏览器界面状态，包括了安全状态、地址栏的 URL、前进后退的历史状态，并更新 Web 页面。

5. 渲染阶段

   > 一旦文档被提交，渲染进程便开始页面解析和子资源加载

**思考题：从输入 URL 到页面展示，这中间发生了什么？**

不考虑用户输入搜索关键字的情况：
  1，用户输入url并回车
  2，浏览器进程检查url，组装协议，构成完整的url
  3，浏览器进程通过进程间通信（IPC）把url请求发送给网络进程
  4，网络进程接收到url请求后检查本地缓存是否缓存了该请求资源，如果有则将该资源返回给浏览器进程
  5，如果没有，网络进程向web服务器发起http请求（网络请求），请求流程如下：
    5.1 进行DNS解析，获取服务器ip地址，端口（端口是通过dns解析获取的吗？这里有个疑问）
    5.2 利用ip地址和服务器建立tcp连接
    5.3 构建请求头信息
    5.4 发送请求头信息
    5.5 服务器响应后，网络进程接收响应头和响应信息，并解析响应内容
  6，网络进程解析响应流程；
    6.1 检查状态码，如果是301/302，则需要重定向，从Location自动中读取地址，重新进行第4步
      （301/302跳转也会读取本地缓存吗？这里有个疑问），如果是200，则继续处理请求。
    6.2 200响应处理：
      检查响应类型Content-Type，如果是字节流类型，则将该请求提交给下载管理器，该导航流程结束，不再进行
      后续的渲染，如果是html则通知浏览器进程准备渲染进程准备进行渲染。
  7，准备渲染进程
    7.1 浏览器进程检查当前url是否和之前打开的渲染进程根域名是否相同，如果相同，则复用原来的进程，如果不同，则开启新的渲染进程
  \8. 传输数据、更新状态
    8.1 渲染进程准备好后，浏览器向渲染进程发起“提交文档”的消息，渲染进程接收到消息和网络进程建立传输数据的“管道”
    8.2 渲染进程接收完数据后，向浏览器发送“确认提交”
    8.3 浏览器进程接收到确认消息后更新浏览器界面状态：安全、地址栏url、前进后退的历史状态、更新web页面。

`总结`

>- 服务器可以根据响应头来控制浏览器的行为，如跳转、网络数据类型判断。
>- Chrome 默认采用每个标签对应一个渲染进程，但是如果两个页面属于同一站点，那这两个标签会使用同一个渲染进程。
>- 浏览器的导航过程涵盖了从用户发起请求到提交文档给渲染进程的中间所有阶段。

