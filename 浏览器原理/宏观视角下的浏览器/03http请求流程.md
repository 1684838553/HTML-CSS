## 03 | HTTP 请求流程：为什么很多站点第二次打开速度会很快？

> HTTP 协议，正是建立在 TCP 连接基础之上的。HTTP 是一种允许浏览器向服务器获取资源的协议，是 Web 的基础，通常由浏览器发起请求，用来获取不同类型的文件，例如 HTML 文件、CSS 文件、JavaScript 文件、图片、视频等

### 为什么通常在第一次访问一个站点时，打开速度很慢，当再次访问这个站点时，速度就很快了？当登录过一个网站之后，下次再访问该站点，就已经处于登录状态了，这是怎么做到的呢？

> 1. 主要原因是第一次加载页面过程中，缓存了一些耗时的数据。DNS 缓存和页面资源缓存这两块数据是会被浏览器缓存的。其中，DNS 缓存比较简单，它主要就是在浏览器本地把对应的 IP 和域名关联起来，**可查看 image 文件夹中缓存查找流程示意图**，浏览器是通过响应头中的 Cache-Control 字段来设置是否缓存该资源
>
>    Cache-Control:Max-age=2000 //缓存过期时间 2000s
>
>    请求时，缓存未过期，直接返回缓存中的资源给浏览器；缓存过期，发送网络请求，在 http 请求头中带上 If-None-Match:"4f80f-13c-3a1xb12a"，如果资源更新，服务器返回最新资源，否则，返回 304,告诉浏览器缓存可以继续使用
>
>    简单来说，很多网站第二次访问能够秒开，是因为这些网站把很多资源都缓存在了本地，浏览器缓存直接使用本地副本来回应请求，而不会产生真实的网络请求，从而节省了时间。同时，DNS 数据也被浏览器缓存了，这又省去了 DNS 查询环节
>
> 2. - 用户登录，调用 post 将登录信息发送给服务器
>    - 服务器收到信息，验证信息是否正确。正确，返回一段表示身份的字符串，把该字符串写到响应头 Set-Cookie 字段里面，如 Set-Cookie: UID=3431uad;发送给浏览器
>    - 浏览器收到响应，解析响应头，如果响应头中含有 Set-Cookie 字段，将它保存到本地
>    - 用户再次访问，浏览器发起请求，浏览器读取之前保存的 Set-Cookie 字段，并写进请求头的 Cookie 字段中，发送给浏览器，如 Cookie: UID=3431uad;
>    - 服务器查找到 Cookie 字段信息，判断用户为已登入状态，就会给浏览器发送含有该用户信息的页面数据
>    - 浏览器收到信息，就可正确展示用户登录的状态信息 **可查看 image 文件夹中 Cookie 流程图**

### 浏览器端发起 HTTP 请求流程

1. 构建请求

   > 浏览器构建请求行信息（如下所示），构建好后，浏览器准备发起网络请求
   >
   > GET /index.html HTTP1.1

2. 查找缓存
   
   > 在真正发起网络请求之前，浏览器会先在浏览器缓存中查询是否有要请求的文件
   
   **浏览器缓存是一种在本地保存资源副本，以供下次请求时直接使用的技术。**当浏览器发现请求的资源已经在浏览器缓存中存有副本，它会拦截请求，返回该资源的副本，并直接结束请求，而不会再去源服务器重新下载。如果缓存查找失败，将会进入网络请求。
   
   **优点：**
   
   - 缓解服务器压力，提升性能（获取资源的耗时更短了）
   - 对网站来说，缓存是实现资源快速加载的重要组成部分
   
3. 准备 ip 和端口(域名解析)

   > 先理解 tcp 和 http 之间的关系，结果 image 中的 TCP 和 HTTP 的关系示意图.png
   >
   > HTTP 的内容是通过 TCP 的传输数据阶段来实现的

   **网络请求第一步做什么？**

   - 建立 tcp 链接，这一步需要 ip 和端口，一般来说，我们有 url 地址，那么我们要做的是域名解析，请求域名对应的 ip

   负责把域名和 IP 地址做一一映射关系。这套域名映射为 IP 的系统就叫做“域名系统”，简称 DNS

   浏览器还提供了 DNS 数据缓存服务，如果某个域名已经解析过了，那么浏览器会缓存解析的结果，以供下次查询时直接使用，这样也会减少一次网络请求

4. 等待 tcp 队列

   **ip 和端口都有了，下一步并不能直接建立 tcp 链接**

   > Chrome 有个机制，同一个域名同时最多只能建立 6 个 TCP 连接，如果在同一个域名下同时有 10 个请求发生，那么其中 4 个请求会进入排队等待状态，直至进行中的请求完成。当然，如果当前请求数量少于 6，会直接进入下一步，建立 TCP 连接。

5. 建立 tcp 连接

   > 三次握手

6. 发送 http 请求

   > 一旦建立了 TCP 连接，浏览器就可以和服务器进行通信了。而 HTTP 中的数据正是在这个通信过程中传输的。

### 服务器端处理 HTTP 请求流程

1. 返回请求

   > 服务器处理结束，便可以返回数据给浏览器了。对于无法处理或处理出错的消息，服务器会通过状态码来告诉浏览器它的处理结果

2. 断开连接

   > 通常情况下，一旦服务器向客户端返回了请求数据，它就要关闭 TCP 连接
   >
   > 如果在 http 请求中加`Connection:Keep-Alive`，tcp 连接在发送后然保持打开状态，浏览器可继续通过该 tcp 发送请求
   >
   > `保持 TCP 连接可以省去下次请求时需要建立连接的时间，提升资源加载速度。`比如，一个 Web 页面中内嵌的图片就都来自同一个 Web 站点，如果初始化了一个持久连接，你就可以复用该连接，以请求其他资源，而不需要重新再建立新的 TCP 连接。

3. 重定向

   > 当你在浏览器中打开 geekbang.org 后，你会发现最终打开的页面地址是 https://www.geekbang.org。
   >
   > 这两个 URL 之所以不一样，是因为涉及到了一个重定向操作
   >
   > 响应行返回的状态码是 301，状态 301 就是告诉浏览器，我需要重定向到另外一个网址

**思考题：如果一个页面的网络加载时间过久，你是如何分析卡在哪个阶段的？**

1、 首先猜测最可能的出问题的地方，网络传输丢包比较严重，需要不断重传。然后通过 ping curl 看看对应的时延高不高。
2 、然后通过 wireshake 看看具体哪里出了问题。
3 、假如别人访问很快，自己电脑很慢，就要看看自己客户端是否有问题了

`总结`

> 浏览器中的 HTTP 请求从发起到结束一共经历了如下八个阶段：**可查看 image 文件夹中 HTTP 请求流程示意图**
>
> 1. 构建请求
>
> 2. 查找缓存
>
> 3. 准备 IP 和端口
>
> 4. 等待 TCP 队列
> 5. 建立 TCP 连接
> 6. 发起 HTTP 请求
> 7. 服务器处理请求
> 8. 服务器返回请求和断开连接
